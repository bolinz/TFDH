language: minimal
services: 
  - docker
before_install:
  - echo "${dockerhub_token}"|docker login -u ${dockerhub_user} --password-stdin
install:
  - curl https://releases.hashicorp.com/terraform/1.1.9/terraform_1.1.9_linux_amd64.zip -o terraform.zip
  - unzip terraform.zip
  - chmod +x terraform
  - git clone -b v1.5.0 https://github.com/bolinz/kubeflow-manifests.git
  - curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh"  | bash
  - chmod +x ./kustomize
before_script:
  #- "./kustomize build kubeflow-manifests/example|grep ' image: '|grep -v '{' > images"
  - echo "ghcr.io/googlecloudplatform/spark-operator:v1beta2-1.3.7-3.1.1" > images
  - sed -i 's/.*image://' images
  #- sed -i 's/@sha256:.*/:v0\.22\.1/' images
  - cat images |uniq|awk 'BEGIN{ FS = ":|@" }{print $0 " " $1 " " $2 }'|awk '{gsub("\\.|\\/|@","_",$2) ;gsub("sha256","v0.22.1",$3);print $1" "$2" "substr($3,1,10)}' > docker_hub_action
  - cat docker_hub_action
script:
  - export TF_VAR_dockerhub_token=${dockerhub_token}
  - export TF_VAR_dockerhub_user=${dockerhub_user}
  - ./terraform version
  - ./terraform init
  - ./terraform plan
  - ./terraform apply -input=false -auto-approve
#script:
  - cat docker_hub_action | awk '{system("docker pull " $1)}'
  - cat docker_hub_action | awk '{system("docker tag "$1" docker.io/${dockerhub_user}/"$2":"$3)}'
  - cat docker_hub_action | awk '{system("docker push docker.io/${dockerhub_user}/"$2":"$3)}'

#after_success:
#  - cat docker_hub_action | awk '{system("docker pull " $1)}'
#  - cat docker_hub_action | awk '{system("docker tag "$1" docker.io/bolinz/"$2":"$3)}'
#  - cat docker_hub_action | awk '{system("docker push docker.io/bolinz/"$2":"$3)}'
#after_failure:
#  - cat docker_hub_action | awk '{system("docker pull " $1)}'
#  - cat docker_hub_action | awk '{system("docker tag "$1" docker.io/bolinz/"$2":"$3)}'
#  - cat docker_hub_action | awk '{system("docker push docker.io/bolinz/"$2":"$3)}'